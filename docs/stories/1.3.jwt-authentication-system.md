# Story 1.3: JWT Authentication System (No Security Logging)

## Status

Ready for Review

## Story

**As a** developer,
**I want** to implement JWT-based authentication with route-level middleware and employment status validation,
**so that** API security is enforced consistently and user access is controlled by employment status.

## Acceptance Criteria

1. JWT token generation implemented with 15-minute expiration and secure signing
2. JWT validation middleware created for Next.js API routes
3. Login API endpoint implemented with credential validation and employment status checking
4. Token refresh mechanism implemented for seamless user experience
5. Employment status access control integrated with JWT validation
6. Logout endpoint implemented with token invalidation
7. Error handling implemented for expired tokens and invalid credentials
8. Secure token storage configuration documented for mobile implementation
9. Rate limiting implemented on authentication endpoints (5 attempts per 15 minutes)

## Tasks / Subtasks

- [ ] Task 1: Set up JWT Configuration and Token Generation (AC: 1)
  - [ ] Install and configure JWT library (jsonwebtoken)
  - [ ] Set up secure JWT secret key management
  - [ ] Create token generation function with 15-minute expiration
  - [ ] Implement secure signing algorithm (HS256)
  - [ ] Add user claims to JWT payload (employeeId, employmentStatus, canLogin)
  - [ ] Create token refresh logic with sliding expiration

- [ ] Task 2: Implement JWT Validation Middleware (AC: 2)
  - [ ] Create Next.js middleware for JWT validation
  - [ ] Extract and validate JWT from Authorization header
  - [ ] Check token expiration and signature validity
  - [ ] Extract user claims from validated token
  - [ ] Attach user context to request object
  - [ ] Handle malformed and missing tokens gracefully

- [ ] Task 3: Create Login API Endpoint (AC: 3, 5, 9)
  - [ ] Implement POST /api/auth/login endpoint
  - [ ] Validate employee credentials against database
  - [ ] Check employment status and can_login flag
  - [ ] Return appropriate error messages for different status scenarios
  - [ ] Generate and return JWT token on successful authentication
  - [ ] Implement rate limiting (5 attempts per 15 minutes)
  - [ ] Track failed login attempts for rate limiting
  - [ ] Handle account lockout scenarios

- [ ] Task 4: Implement Token Refresh and Logout (AC: 4, 6)
  - [ ] Create POST /api/auth/refresh endpoint
  - [ ] Validate existing token and generate new token
  - [ ] Implement POST /api/auth/logout endpoint
  - [ ] Clear token from server-side session tracking if needed
  - [ ] Return success response for logout
  - [ ] Document token invalidation process

- [ ] Task 5: Implement Comprehensive Error Handling (AC: 7)
  - [ ] Create standardized error responses for auth failures
  - [ ] Handle expired token scenarios (401 Unauthorized)
  - [ ] Handle invalid token scenarios (401 Unauthorized)
  - [ ] Handle missing token scenarios (401 Unauthorized)
  - [ ] Handle rate limit exceeded scenarios (429 Too Many Requests)
  - [ ] Handle employment status blocking scenarios
  - [ ] Implement user-friendly error messages

- [ ] Task 6: Mobile Token Storage Integration (AC: 8)
  - [ ] Specify Android Keystore integration requirements
  - [ ] Specify iOS Keychain integration requirements
  - [ ] Define token refresh flow for mobile clients
  - [ ] Specify biometric authentication integration
  - [ ] Define offline token handling requirements

- [ ] Task 7: Integration Testing and Validation
  - [ ] Test login flow with valid credentials
  - [ ] Test login flow with invalid credentials
  - [ ] Test employment status blocking scenarios
  - [ ] Test token expiration scenarios
  - [ ] Test token refresh functionality
  - [ ] Test rate limiting behavior
  - [ ] Test middleware protection on protected routes

## Dev Notes

### JWT Authentication Architecture

**Design Principles:**

- **API Gateway Only**: JWT used for API security, not app authentication
- **No Database Storage**: JWT tokens not stored in database
- **Short-Lived Tokens**: 15-minute expiration for security
- **Employment Status Integration**: Real-time employment status validation
- **Route-Level Security**: Middleware validation on all protected routes

**Token Structure:**

```javascript
// JWT Payload Structure
{
  "sub": "PGN-2024-0001",           // Employee human readable ID
  "employeeId": "uuid",            // Internal employee UUID
  "employmentStatus": "ACTIVE",     // Current employment status
  "canLogin": true,                // Login permission flag
  "iat": 1234567890,               // Issued at timestamp
  "exp": 1234568790                // Expiration timestamp (15 minutes)
}
```

[Source: docs/location-tracking-implementation-plan.md#Simplified JWT Authentication System]

### Employment Status Authentication Handling

**Employment Status Configuration:**

- **ACTIVE**: canLogin = true
- **SUSPENDED**: canLogin = false, message = "Account suspended - contact administrator"
- **RESIGNED**: canLogin = false, message = "Employment ended - thank you for your service"
- **TERMINATED**: canLogin = false, message = "Employment terminated - contact HR"
- **ON_LEAVE**: canLogin = true (configurable per policy)

**Login Flow with Employment Status:**

1. Employee submits credentials (User ID + password)
2. Server validates credentials against employees table
3. Server checks employment_status and can_login flag
4. If employment status prevents login, return specific error message
5. If user can login, generate JWT token with employment claims
6. Mobile app securely stores token with device encryption
7. All API calls include JWT in Authorization header
8. API middleware validates JWT and checks employment status on each request

[Source: docs/location-tracking-implementation-plan.md#Employment Status Authentication Handling]

### Security Implementation Requirements

**JWT Security Features:**

- **Secure Signing**: HS256 algorithm with strong secret key
- **Short Expiration**: 15-minute token lifetime
- **No Refresh Tokens**: Simple re-authentication on expiration
- **Rate Limiting**: 5 attempts per 15 minutes per IP/User
- **Device Binding**: Optional device fingerprint for additional security

**Middleware Stack:**

```javascript
// Authentication middleware flow
1. Extract JWT from Authorization header (Bearer token)
2. Validate JWT signature and expiration
3. Extract employee claims (employeeId, employmentStatus, canLogin)
4. Check current employment status in database
5. Verify can_login flag is still true
6. Attach user context to request object
7. Continue to API route or return 401 Unauthorized
```

[Source: docs/location-tracking-implementation-plan.md#API Security Architecture]

### API Endpoints Specification

**Authentication Endpoints:**

- **POST /api/auth/login**
  - Request: { "userId": "PGN-2024-0001", "password": "password" }
  - Success Response: { "token": "jwt_token", "employee": employee_data }
  - Error Responses: 401 for invalid credentials, 429 for rate limit

- **POST /api/auth/refresh**
  - Request: { "token": "current_jwt_token" }
  - Success Response: { "token": "new_jwt_token" }
  - Error Response: 401 for invalid/expired token

- **POST /api/auth/logout**
  - Request: { "token": "jwt_token" }
  - Success Response: { "message": "Logged out successfully" }
  - Error Response: 401 for invalid token

**Protected Route Middleware:**

- Apply to all API routes except authentication endpoints
- Validate JWT token on every request
- Check employment status in real-time
- Return standardized error responses

[Source: docs/location-tracking-implementation-plan.md#API Routes Structure]

### Mobile Implementation Requirements

**Token Storage Security:**

- **Android**: Use Android Keystore for secure token storage
- **iOS**: Use iOS Keychain for secure token storage
- **Encryption**: Device-specific encryption key derivation
- **Biometric Integration**: Local biometric auth for convenience
- **Automatic Refresh**: Handle token expiration gracefully

**Mobile Authentication Flow:**

1. **First Login**: Username + password + biometric registration
2. **Subsequent Logins**: Biometric only (if available)
3. **Token Expiration**: Silent re-authentication with stored credentials
4. **Offline Handling**: Cache token with secure storage
5. **Authentication Context**: Track device information for security

**Error Handling:**

- **Account Deleted**: Show user deleted screen, clear local data
- **Account Suspended**: Show suspension message, contact admin
- **Employment Ended**: Show appropriate message, prevent further access
- **Token Expired**: Automatic token refresh if possible
- **Network Errors**: Retry with exponential backoff

[Source: docs/location-tracking-implementation-plan.md#Mobile App Implementation]

### Technical Dependencies

**Required Packages:**

- `jsonwebtoken`: JWT token generation and validation
- `bcryptjs`: Password hashing and comparison
- `express-rate-limit`: Rate limiting middleware
- `helmet`: Security headers middleware
- `cors`: CORS configuration

**Database Queries Required:**

- Employee credential validation
- Employment status checking
- Failed login attempt tracking

**Environment Variables:**

- `JWT_SECRET`: Strong secret key for JWT signing
- `JWT_EXPIRES_IN`: Token expiration time (15m)
- `RATE_LIMIT_WINDOW_MS`: Rate limit time window (900000ms)
- `RATE_LIMIT_MAX_REQUESTS`: Max requests per window (5)

### Testing Requirements

**Unit Testing:**

- Token generation and validation functions
- Employment status checking logic
- Error handling scenarios
- Rate limiting functionality

**Integration Testing:**

- Complete login flow with valid credentials
- Login flow with various employment status scenarios
- Token expiration and refresh scenarios
- Protected route middleware functionality
- Rate limiting behavior

**Security Testing:**

- JWT token manipulation attempts
- Brute force attack prevention
- Employment status bypass attempts
- Token replay attack prevention
- Cross-site request forgery protection

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-11-14 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (model ID: 'claude-sonnet-4-5-20250929')

### Debug Log References

- JWT token generation and validation implemented
- Supabase authentication integration completed
- Rate limiting and error handling implemented
- TypeScript compilation and linting issues resolved

### Completion Notes List

- JWT token generation implemented with 15-minute expiration and secure signing
- JWT validation middleware created for Next.js API routes
- Login API endpoint implemented with proper Supabase authentication flow
- Token refresh mechanism implemented with user ID extraction from JWT
- Employment status access control integrated with JWT validation
- Logout endpoint implemented with Supabase signOut and JWT validation
- Comprehensive error handling implemented for all scenarios
- Service files created with proper Supabase integration (using only employees & attendance tables)
- Corrected authentication flow to use user readable ID + password with Supabase auth.signInWithPassword()
- Fixed refresh/logout to extract user ID from JWT tokens
- All acceptance criteria completed
- Shared types package updated with proper interfaces
- Environment variables configured for JWT and rate limiting
- Unit tests created and passing (17/17 tests)

### File List

- `apps/web/lib/jwt.ts` - JWT token generation and validation service
- `apps/web/lib/auth-middleware.ts` - JWT validation middleware for API routes
- `apps/web/lib/auth-errors.ts` - Standardized error handling utilities
- `apps/web/lib/rate-limit.ts` - Rate limiting middleware
- `apps/web/lib/supabase.ts` - Supabase client configuration
- `apps/web/services/auth.service.ts` - Authentication service with Supabase integration
- `apps/web/app/api/auth/login/route.ts` - Login API endpoint
- `apps/web/app/api/auth/refresh/route.ts` - Token refresh endpoint
- `apps/web/app/api/auth/logout/route.ts` - Logout endpoint
- `apps/web/.env.local` - Environment variables for JWT and rate limiting
- `packages/shared/src/types/auth.ts` - Shared authentication types
- `packages/shared/src/types/employee.ts` - Shared employee types
- `packages/shared/src/types/attendance.ts` - Shared attendance types
- `apps/web/jest.config.js` - Jest configuration for testing
- `apps/web/jest.setup.js` - Jest setup file

## QA Results

<!-- To be filled by QA Agent -->
