# Story 1.4: Service Layer Architecture (Simplified)

## Status
Draft

## Story
**As a** developer,
**I want** to implement a secure service layer that encapsulates all database operations and business logic,
**so that** API routes remain thin and all data access follows consistent security patterns.

## Acceptance Criteria
1. Base service class created with common database operations and security checks
2. Employee service implemented with CRUD operations and employment status validation
3. Attendance service implemented with business logic for check-in/check-out validation
4. Location service implemented for GPS tracking and path data management
5. All service functions include proper error handling and validation
6. Database transaction handling implemented for data consistency
7. Service integration tests created for critical operations
8. API routes properly integrated with service layer

## Tasks / Subtasks
- [ ] Task 1: Create Base Service Class (AC: 1)
  - [ ] Create BaseService class with common database operations
  - [ ] Implement Supabase client connection management
  - [ ] Add error handling and logging base functionality
  - [ ] Create reusable validation methods
  - [ ] Implement transaction handling utilities
  - [ ] Add security context management (employee context from JWT)

- [ ] Task 2: Implement Employee Service (AC: 2)
  - [ ] Create EmployeeService class extending BaseService
  - [ ] Implement employee CRUD operations
    - [ ] getEmployeeById() with employment status validation
    - [ ] getEmployeeByHumanReadableId() for login operations
    - [ ] updateEmployee() with employment status tracking
    - [ ] createEmployee() with validation
    - [ ] deleteEmployee() with soft delete option
  - [ ] Add employment status management methods
  - [ ] Implement password hashing and validation
  - [ ] Add failed login attempt tracking for rate limiting

- [ ] Task 3: Implement Attendance Service (AC: 3)
  - [ ] Create AttendanceService class extending BaseService
  - [ ] Implement check-in functionality
    - [ ] validateCheckInData() with business rules
    - [ ] processCheckIn() with selfie data handling
    - [ ] createDailyAttendanceRecord() with unique constraint handling
  - [ ] Implement check-out functionality
    - [ ] validateCheckOutData() with business rules
    - [ ] processCheckOut() with work hours calculation
    - [ ] updateDailyAttendanceRecord() with completion logic
  - [ ] Add attendance status management
  - [ ] Implement location data validation (GPS accuracy, reasonable movement)

- [ ] Task 4: Implement Location Service (AC: 4)
  - [ ] Create LocationService class extending BaseService
  - [ ] Implement location update functionality
    - [ ] validateLocationData() with accuracy and movement checks
    - [ ] updateLocation() with 50m movement threshold filtering
    - [ ] processPathSegment() for efficient path storage
  - [ ] Add path data management
    - [ ] getPathData() for employee daily paths
    - [ ] calculateTotalDistance() for work metrics
    - [ ] generatePathSummary() for statistics
  - [ ] Implement battery level tracking integration
  - [ ] Add location-based business rule validation

- [ ] Task 5: Create API Route Integration (AC: 8)
  - [ ] Update existing API routes to use service layer
    - [ ] Convert /api/auth/login to use EmployeeService
    - [ ] Convert attendance endpoints to use AttendanceService
    - [ ] Convert location endpoints to use LocationService
  - [ ] Remove direct Supabase queries from API routes
  - [ ] Implement proper error propagation from services to routes
  - [ ] Add request context passing to service methods
  - [ ] Ensure all routes use service layer for database operations

- [ ] Task 6: Add Error Handling and Validation (AC: 5)
  - [ ] Implement comprehensive error handling in all services
  - [ ] Create standardized error response format
  - [ ] Add input validation for all service methods
  - [ ] Implement database constraint handling (unique violations, foreign keys)
  - [ ] Add proper HTTP status code mapping
  - [ ] Create custom error classes for different error types

- [ ] Task 7: Implement Database Transactions (AC: 6)
  - [ ] Add transaction support to BaseService
  - [ ] Implement complex operations in transactions (attendance check-in/out)
  - [ ] Add rollback handling for failed operations
  - [ ] Create transaction utility methods for common patterns
  - [ ] Add logging for transaction operations
  - [ ] Test transaction rollback scenarios

- [ ] Task 8: Create Service Integration Tests (AC: 7)
  - [ ] Create test environment with database setup
  - [ ] Write unit tests for all service methods
  - [ ] Write integration tests for complex operations
  - [ ] Test error handling scenarios
  - [ ] Test transaction rollback functionality
  - [ ] Test employment status validation across services
  - [ ] Create performance tests for critical operations

## Dev Notes

### Service Layer Architecture

**Design Principles:**
- **Service File Isolation**: Only service files can directly access Supabase
- **API Route as Gateway**: All client requests must go through API routes
- **Shared Service Layer**: Both mobile and web use the same service layer
- **Security Context**: Employee context passed from JWT middleware to services
- **Database Transactions**: Complex operations wrapped in proper transactions

**Service Structure:**
```
apps/web/app/services/
├── base/
│   ├── BaseService.ts          # Common database operations
│   ├── types.ts               # Service-specific types
│   └── errors.ts              # Custom error classes
├── employee/
│   └── EmployeeService.ts      # Employee CRUD and status management
├── attendance/
│   └── AttendanceService.ts    # Attendance business logic
└── location/
    └── LocationService.ts      # Location tracking and path management
```

[Source: docs/location-tracking-implementation-plan.md#Service Layer Architecture]

### BaseService Class

**Core Functionality:**
```typescript
abstract class BaseService {
  protected supabase: SupabaseClient
  protected employeeContext?: EmployeeContext

  constructor(employeeContext?: EmployeeContext) {
    this.supabase = createSupabaseClient()
    this.employeeContext = employeeContext
  }

  // Common database operations
  protected async create<T>(table: string, data: T): Promise<T>
  protected async update<T>(table: string, id: string, data: Partial<T>): Promise<T>
  protected async getById<T>(table: string, id: string): Promise<T | null>
  protected async delete(table: string, id: string): Promise<void>

  // Transaction support
  protected async transaction<T>(operation: () => Promise<T>): Promise<T>

  // Validation utilities
  protected validateRequired(data: any, requiredFields: string[]): void
  protected validateUUID(id: string): void
}
```

**Security Context Management:**
- Employee context extracted from JWT in API routes
- Passed to service constructors for authorization
- Used for RLS policy enforcement
- Employment status validated in service methods

[Source: docs/location-tracking-implementation-plan.md#Service Layer Security]

### Employee Service

**CRUD Operations with Employment Status:**
```typescript
class EmployeeService extends BaseService {
  async login(userId: string, password: string): Promise<LoginResult>
  async getEmployeeById(id: string): Promise<Employee | null>
  async updateEmploymentStatus(id: string, status: EmploymentStatus, reason?: string, changedBy?: string): Promise<Employee>
  async incrementFailedLoginAttempts(userId: string): Promise<void>
  async resetFailedLoginAttempts(userId: string): Promise<void>
  async updateLastLogin(userId: string): Promise<void>
}
```

**Employment Status Integration:**
- Real-time employment status validation
- can_login flag checking for all operations
- Employment status change tracking with audit information
- Automatic access control based on employment status

[Source: docs/location-tracking-implementation-plan.md#Employment Status Management]

### Attendance Service

**Check-in/Check-out Business Logic:**
```typescript
class AttendanceService extends BaseService {
  async checkIn(data: CheckInData): Promise<AttendanceRecord>
  async checkOut(data: CheckOutData): Promise<AttendanceRecord>
  async getCurrentAttendance(employeeId: string): Promise<AttendanceRecord | null>
  async getAttendanceByDate(employeeId: string, date: string): Promise<AttendanceRecord | null>
  async verifyAttendance(attendanceId: string, verifiedBy: string, status: VerificationStatus): Promise<void>
}
```

**Business Rules:**
- One attendance record per employee per day (UNIQUE constraint)
- Check-in requires selfie data and GPS location
- Check-out calculates total work hours
- Verification workflow for manual review
- Emergency check-out handling

[Source: docs/location-tracking-implementation-plan.md#Enhanced Attendance Management]

### Location Service

**GPS Tracking with Movement Threshold:**
```typescript
class LocationService extends BaseService {
  async updateLocation(data: LocationData): Promise<void>
  async getPathData(employeeId: string, date: string): Promise<LocationPoint[]>
  async calculateTotalDistance(pathData: LocationPoint[]): Promise<number>
  async generatePathSummary(pathData: LocationPoint[]): Promise<PathSummary>
  async validateLocationData(data: LocationData): Promise<boolean>
}
```

**Movement Threshold Logic:**
- 50-meter minimum movement before adding to path
- GPS accuracy validation
- Battery level tracking integration
- Path segment management for efficient storage

[Source: docs/location-tracking-implementation-plan.md#Location Tracking Implementation]

### API Route Integration

**Route Structure Update:**
```typescript
// Before: Direct Supabase access
export async function POST(request: Request) {
  const { data } = await request.json()
  const { data, error } = await supabase
    .from('table')
    .insert(data)
}

// After: Service layer integration
export async function POST(request: Request) {
  const employeeContext = getEmployeeContext(request)
  const service = new AttendanceService(employeeContext)
  const result = await service.checkIn(data)
  return NextResponse.json(result)
}
```

**Benefits:**
- Thin API routes focused on HTTP concerns
- Business logic encapsulated in services
- Consistent error handling across routes
- Easy testing of business logic
- Shared logic between mobile and web

[Source: docs/location-tracking-implementation-plan.md#API Routes Structure]

### Error Handling Strategy

**Custom Error Classes:**
```typescript
class ValidationError extends Error {
  constructor(message: string, public field?: string) {
    super(message)
    this.name = 'ValidationError'
  }
}

class EmploymentStatusError extends Error {
  constructor(message: string, public status: EmploymentStatus) {
    super(message)
    this.name = 'EmploymentStatusError'
  }
}

class DuplicateAttendanceError extends Error {
  constructor(message: string, public date: string) {
    super(message)
    this.name = 'DuplicateAttendanceError'
  }
}
```

**Error Response Format:**
```typescript
interface ErrorResponse {
  error: string
  code: string
  details?: any
  timestamp: string
}
```

### Testing Requirements

**Unit Testing:**
- All service methods with valid inputs
- Error scenarios and edge cases
- Employment status validation logic
- Location data validation
- Transaction rollback scenarios

**Integration Testing:**
- Complete attendance workflows
- Employment status changes
- Complex transaction operations
- API route to service integration
- Database constraint handling

**Test Environment Setup:**
- Isolated test database
- Mocked employee contexts
- Test data fixtures
- Database cleanup between tests

### Technical Dependencies

**Required Packages:**
- `@supabase/supabase-js`: Supabase client
- `@types/supabase`: TypeScript types
- `bcryptjs`: Password hashing for employee service
- `uuid`: UUID generation for testing

**Environment Variables:**
- `SUPABASE_URL`: Supabase project URL
- `SUPABASE_ANON_KEY`: Supabase anonymous key
- `SUPABASE_SERVICE_ROLE_KEY`: Service role key for elevated operations

### Database Integration

**Service-Specific Queries:**
- Employee authentication and status management
- Attendance record creation with unique constraints
- Location data with JSONB path storage
- Transaction handling for complex operations
- RLS policy enforcement through employee context

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-14 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->