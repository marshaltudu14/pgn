# Story 1.5: Basic User Management Interface

## Status

Ready for Review

## Story

**As a** user with management privileges,
**I want** a basic web interface to create and manage employee accounts,
**so that** users can be onboarded and managed through the system.

## Acceptance Criteria

1. Login page created with email/password authentication using Supabase Auth
2. Dashboard route protection implemented with middleware to check authentication and role
3. Proxy.ts updated with authentication and role-based access checks
4. Supabase RLS policies updated for employees and daily_attendance tables
5. Admin role (test@example.com) can create, edit, and view all rows but cannot delete
6. Regular users can only view their own rows in both tables
7. Zustand stores created for client-side state management
8. Employee list page created with search and filtering capabilities
9. Create employee form implemented with validation for required fields
10. Edit employee form implemented with proper validation
11. Employment status management implemented with dropdown selection
12. User ID generation implemented in PGN-YYYY-NNNN format
13. Employment status change confirmation implemented
14. Basic validation implemented for email and phone number formats
15. Responsive design implemented for desktop and tablet access
16. Loading states and error handling implemented for all operations

## Tasks / Subtasks

### Authentication & Authorization Tasks

- [x] Task 0: Create Authentication System (AC: 1)
  - [x] Create login page with email/password fields using Supabase Auth
  - [x] Implement login form validation and error handling
  - [x] Add loading states for login process
  - [x] Handle authentication success and redirect to dashboard
  - [x] Handle logout functionality
  - [x] Create auth store using Zustand for global auth state

- [x] Task 1: Set Up Route Protection and Middleware (AC: 2, 3)
  - [x] Create middleware.ts for route protection
  - [x] Implement authentication check in middleware
  - [x] Add role-based access control from user metadata
  - [x] Update proxy.ts with authentication and role checks
  - [x] Create protected route wrapper for dashboard routes
  - [x] Handle unauthorized access redirects

- [x] Task 2: Configure Supabase RLS Policies (AC: 4, 5, 6)
  - [x] Enable RLS on employees and daily_attendance tables
  - [x] Create admin RLS policies for test@example.com user
  - [x] Create user-specific RLS policies for regular users
  - [x] Test admin policies: can SELECT, INSERT, UPDATE all rows
  - [x] Test user policies: can SELECT own rows only
  - [x] Ensure no DELETE policies exist for any user

- [x] Task 3: Assign Admin Role and Update User Metadata (AC: 5)
  - [x] Update test@example.com user metadata to include admin role
  - [x] Verify admin role assignment in Supabase Auth users table
  - [x] Test role extraction from raw_user_metadata
  - [x] Create role utility functions for client and server
  - [x] Test admin access with role-based permissions

### State Management Tasks

- [x] Task 4: Create Zustand Stores (AC: 7)
  - [x] Create auth store for authentication state
  - [x] Create employee store for employee data management
  - [x] Create UI store for loading states and notifications
  - [x] Implement store persistence for auth tokens
  - [x] Create store actions for API calls
  - [x] Add store selectors for derived state

### UI Tasks (Updated from previous version)

- [x] Task 5: Set Up Basic Dashboard Structure (AC: 15)
  - [x] Create Next.js dashboard pages structure using (dashboard) route groups
  - [x] Implement responsive layout with header and sidebar
  - [x] Set up navigation for dashboard sections
  - [x] Create basic styling and theme consistency
  - [x] Add mobile responsive breakpoints
  - [x] Implement loading and error state components

- [x] Task 6: Create Employee List Page (AC: 8)
  - [x] Create employee listing page with table view
  - [x] Implement search functionality by name and user ID
  - [x] Add filtering by employment status
  - [x] Add sorting capabilities
  - [x] Implement pagination for large datasets
  - [x] Add quick actions (edit, change status) for each employee
  - [x] Display key employee information (ID, name, status, last login)
  - [x] Integrate with employee store for state management

- [x] Task 7: Implement Create Employee Form (AC: 9, 12, 14)
  - [x] Create employee creation form with all required fields
  - [x] Implement automatic user ID generation (PGN-YYYY-NNNN format)
  - [x] Add form validation for required fields
  - [x] Implement email format validation
  - [x] Implement phone number format validation
  - [x] Add password field with secure input handling
  - [x] Implement employment status dropdown
  - [x] Add form submission with loading state using store actions
  - [x] Handle creation success and error responses with notifications

- [x] Task 8: Implement Edit Employee Form (AC: 10, 11, 13)
  - [x] Create employee editing form with pre-filled data
  - [x] Implement form validation for all fields
  - [x] Add employment status management with status dropdown
  - [x] Add reason field for status change documentation
  - [x] Implement form submission with loading state using store actions
  - [x] Handle update success and error responses with notifications
  - [x] Add proper error messaging for validation failures

- [x] Task 9: Implement Employment Status Changes (AC: 13)
  - [x] Add status change button to employee list and edit pages
  - [x] Create confirmation dialog for employment status changes
  - [x] Add reason field for status change documentation
  - [x] Implement status update with user tracking
  - [x] Handle status change success and error responses
  - [x] Update employee list to reflect new status immediately
  - [x] Integrate with employee store actions

- [x] Task 10: Implement Global Error Handling (AC: 16)
  - [x] Create global error boundary for React components
  - [x] Implement toast notifications for success/error messages
  - [x] Add loading spinners for async operations
  - [x] Handle network errors gracefully
  - [x] Implement form validation error display
  - [x] Add retry functionality for failed operations
  - [x] Integrate with UI store for global notifications

- [x] Task 11: Integrate with Service Layer and API Routes
  - [x] Create API routes that call service functions
  - [x] Connect UI components to API routes via Zustand store actions
  - [x] Implement proper error handling from API responses
  - [x] Add data fetching with loading states in stores
  - [x] Update UI state based on API responses
  - [x] Ensure client-side only uses stores and API routes
  - [x] Ensure server-side only calls service files directly

## Dev Notes

### Architecture Overview

**Client-Server Architecture:**

- **Client Side**: React components use Zustand stores for state management
- **Client → Server**: Stores call API routes for data operations
- **Server Side**: API routes call service files for business logic
- **Database Layer**: Service files interact with Supabase directly

**Authentication & Authorization Flow:**

- **Login**: Supabase Auth for email/password authentication
- **Role-Based Access**: Roles stored in user metadata (raw_user_metadata)
- **Route Protection**: Middleware checks auth status and roles
- **RLS Policies**: Database-level security for row access control

**Zustand Store Architecture:**

- **Auth Store**: Global authentication state, user info, tokens
- **Employee Store**: Employee data management, CRUD operations
- **UI Store**: Loading states, notifications, error handling
- **Persistence**: Auth tokens stored securely across sessions

### Validation Requirements

**Phone Validation (India Format):**

```typescript
const phoneRegex = /^[6-9]\d{9}$/;
// Accepts 10-digit Indian mobile numbers starting with 6,7,8,9
// Examples: 9876543210, 9898765432
```

**Password Requirements:**

```typescript
const passwordValidation = {
  minLength: 6,
  requireUppercase: true,
  requireLowercase: true,
  requireNumber: true,
  requireSymbol: true,
};
// Minimum 6 characters with at least one uppercase, one lowercase, one number, and one symbol
```

### RLS Policy Structure

**Admin RLS Policies (test@example.com):**

```sql
-- Employees Table Policies
CREATE POLICY "Admins can view all employees" ON employees
  FOR SELECT USING (auth.jwt() ->> 'email' = 'test@example.com');

CREATE POLICY "Admins can insert employees" ON employees
  FOR INSERT WITH CHECK (auth.jwt() ->> 'email' = 'test@example.com');

CREATE POLICY "Admins can update employees" ON employees
  FOR UPDATE USING (auth.jwt() ->> 'email' = 'test@example.com');

-- Daily Attendance Table Policies
CREATE POLICY "Admins can view all attendance" ON daily_attendance
  FOR SELECT USING (auth.jwt() ->> 'email' = 'test@example.com');

CREATE POLICY "Admins can insert attendance" ON daily_attendance
  FOR INSERT WITH CHECK (auth.jwt() ->> 'email' = 'test@example.com');

CREATE POLICY "Admins can update attendance" ON daily_attendance
  FOR UPDATE USING (auth.jwt() ->> 'email' = 'test@example.com');

-- No DELETE policies allowed
```

**User-Specific RLS Policies:**

```sql
-- Regular Users - Own Data Only
CREATE POLICY "Users can view own employee data" ON employees
  FOR SELECT USING (auth.jwt() ->> 'email' = email);

CREATE POLICY "Users can view own attendance" ON daily_attendance
  FOR SELECT USING (employee_id IN (
    SELECT id FROM employees WHERE email = auth.jwt() ->> 'email'
  ));

-- No INSERT/UPDATE/DELETE policies for regular users
```

**Page Structure (Modern Next.js Client/Server Separation):**

```
apps/web/app/
├── (dashboard)/
│   ├── layout.tsx           # Dashboard layout with navigation (Server)
│   ├── page.tsx             # Main dashboard (Server + Client)
│   ├── employees/
│   │   ├── page.tsx         # Employee list page (Server)
│   │   ├── employees-client.tsx  # Employee list component (Client)
│   │   ├── create/
│   │   │   └── page.tsx     # Create employee page (Server)
│   │   │   └── create-client.tsx # Create form component (Client)
│   │   └── [id]/
│   │       └── edit/
│   │           ├── page.tsx  # Edit employee page (Server)
│   │           └── edit-client.tsx # Edit form component (Client)
│   ├── login/
│   │   ├── page.tsx         # Login page (Server)
│   │   └── login-client.tsx # Login form component (Client)
│   ├── components/          # Shared dashboard components
│   │   ├── ui/              # UI primitives (Client)
│   │   │   ├── button.tsx
│   │   │   ├── input.tsx
│   │   │   ├── table.tsx
│   │   │   └── dialog.tsx
│   │   ├── forms/           # Form components (Client)
│   │   │   ├── EmployeeForm.tsx
│   │   │   ├── LoginForm.tsx
│   │   │   └── SearchFilter.tsx
│   │   ├── lists/           # List components (Client)
│   │   │   ├── EmployeeList.tsx
│   │   │   └── Pagination.tsx
│   │   ├── motion/          # Framer Motion wrappers (Client)
│   │   │   ├── FadeIn.tsx
│   │   │   ├── SlideIn.tsx
│   │   │   └── LayoutTransition.tsx
│   │   └── dialogs/         # Dialog components (Client)
│   │       ├── StatusChangeDialog.tsx
│   │       └── ConfirmDialog.tsx
│   └── lib/
│       ├── stores/          # Zustand stores (Client)
│       │   ├── authStore.ts
│       │   ├── employeeStore.ts
│       │   └── uiStore.ts
│       └── utils/           # Utility functions
│           ├── validation.ts
│           └── pagination.ts
```

[Source: docs/location-tracking-implementation-plan.md#Dashboard Implementation]

### Employee Management Features

**Employee Operations (Create, Read, Update):**

```typescript
// Employee data structure
interface Employee {
  id: string;
  humanReadableUserId: string; // PGN-2024-0001 format
  name: string;
  email: string;
  phone: string;
  employmentStatus:
    | 'ACTIVE'
    | 'SUSPENDED'
    | 'RESIGNED'
    | 'TERMINATED'
    | 'ON_LEAVE';
  isActive: boolean;
  canLogin: boolean;
  lastLoginAt?: string;
  createdAt: string;
  updatedAt: string;
}

// Note: No deletion allowed - only employment status changes
// Data is preserved permanently for compliance and audit purposes
```

**User ID Generation Logic:**

```typescript
const generateUserId = (): string => {
  const year = new Date().getFullYear();
  const count = await getNextSequenceForYear(year);
  return `PGN-${year}-${String(count).padStart(4, '0')}`;
};
// Example: PGN-2024-0001, PGN-2024-0002, etc.
```

**Employment Status Management:**

- **ACTIVE**: Full access, normal operations
- **SUSPENDED**: No login access, data preserved
- **RESIGNED**: No login access, employment ended
- **TERMINATED**: No login access, employment terminated
- **ON_LEAVE**: Configurable access based on policy

[Source: docs/location-tracking-implementation-plan.md#Employment Status Management System]

### Form Validation Requirements

**Required Fields:**

- Name (min 2 characters, max 100 characters)
- Email (valid email format, unique)
- Phone (valid phone format, optional but validated if provided)
- Employment Status (required dropdown selection)

**Email Validation:**

```typescript
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
// Validates standard email format
```

**Phone Validation (India Format):**

```typescript
const phoneRegex = /^[6-9]\d{9}$/;
// Accepts 10-digit Indian mobile numbers starting with 6,7,8,9
// Examples: 9876543210, 9898765432
```

**Password Requirements:**

- Minimum 6 characters
- At least one uppercase letter (A-Z)
- At least one lowercase letter (a-z)
- At least one number (0-9)
- At least one special character (!@#$%^&\*()\_+-=)

[Source: docs/location-tracking-implementation-plan.md#Validation Requirements]

### User Experience Considerations

**Search and Filtering:**

- Real-time search as user types
- Filter by employment status with checkboxes
- Clear search and reset filters functionality
- Maintain search state across page navigation

**Form UX:**

- Progressive disclosure for optional fields
- Real-time validation feedback
- Clear error messages with field highlighting
- Auto-save drafts for long forms
- Confirmation for employment status changes (no destructive actions allowed)
- Clear messaging about data preservation compliance

**Loading States:**

- Skeleton loaders for data loading
- Button loading states for form submissions
- Progress indicators for file uploads
- Offline state handling

### Responsive Design Requirements

**Desktop (>1024px):**

- Two-column layout for forms
- Full table view with all columns
- Sidebar navigation
- Hover states and tooltips

**Tablet (768px - 1024px):**

- Single-column layout
- Collapsible sidebar
- Responsive table with horizontal scroll
- Touch-friendly button sizes

**Mobile (<768px):**

- Stack layout for forms
- Card-based employee list
- Bottom navigation or hamburger menu
- Large touch targets (44px minimum)

### Technical Implementation

**Technology Stack:**

- Next.js 13+ App Router with Server/Client Components
- React Hook Form for form management
- Zod for schema validation
- Tailwind CSS for styling
- Zustand for state management
- Framer Motion for animations and transitions
- Supabase Auth for authentication

**API Integration:**

- RESTful API calls to EmployeeService
- Optimistic updates for better UX
- Error boundary implementation
- Retry logic for failed requests
- Proper HTTP status code handling

**Security Considerations:**

- Role-based access validation
- CSRF protection for forms
- Input sanitization
- Rate limiting for form submissions
- Secure password handling on frontend

### Framer Motion Integration

**Animation Components:**

```typescript
// Example motion components
const FadeIn = ({ children }: { children: React.ReactNode }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    exit={{ opacity: 0, y: -20 }}
    transition={{ duration: 0.3, ease: "easeInOut" }}
  >
    {children}
  </motion.div>
);

const SlideIn = ({ children, direction = "left" }: {
  children: React.ReactNode;
  direction?: "left" | "right" | "up" | "down"
}) => (
  <motion.div
    initial={{
      opacity: 0,
      x: direction === "left" || direction === "right" ? (direction === "left" ? -20 : 20) : 0,
      y: direction === "up" || direction === "down" ? (direction === "up" ? -20 : 20) : 0
    }}
    animate={{ opacity: 1, x: 0, y: 0 }}
    exit={{ opacity: 0 }}
    transition={{ duration: 0.3, ease: "easeInOut" }}
  >
    {children}
  </motion.div>
);
```

**Animation Requirements:**

- Page transitions between dashboard routes
- Fade-in animations for employee list items
- Slide animations for form submissions
- Smooth dialog open/close transitions
- Loading state animations with skeleton components
- Success/error notification animations
- Layout transitions for search/filter results

### Pagination Strategy

**Page-Based Pagination:**

- Cursor-based pagination for better performance than offset/limit
- Maintain search/filter state across page changes
- Previous/Next navigation with page number buttons
- Show current page and total pages
- URL-based pagination state for shareable links
- Infinite scroll option for mobile views

### Rate Limiting Strategy

**In-Browser Rate Limiting:**

- Form submission cooldown (2 seconds between submissions)
- Debounced search inputs (300ms delay)
- Click spam prevention for buttons
- Local storage for rate limit persistence

**In-Memory Server Rate Limiting:**

- Simple request counter per IP/session
- Sliding window approach (100 requests per minute)
- Automatic cleanup of expired rate limit data

### Performance Optimization

**Page Load Optimization:**

- Code splitting for dashboard routes
- Image optimization for employee photos
- Lazy loading for large employee lists
- Framer Motion layout animations for smooth transitions

**Form Performance:**

- Debounced search inputs (300ms delay)
- Optimized re-renders with React.memo
- Efficient state management with Zustand
- Minimal API calls with proper caching
- Optimistic updates for better UX

### Technical Dependencies

**Required Packages:**

- `@supabase/supabase-js`: Supabase client
- `@supabase/auth-ui-react`: Supabase Auth UI components
- `@supabase/auth-ui-shared`: Shared Auth UI styles
- `framer-motion`: Animation library
- `zustand`: State management
- `react-hook-form`: Form management
- `@hookform/resolvers`: Form validation resolvers
- `zod`: Schema validation
- `bcryptjs`: Password hashing for employee service
- `uuid`: UUID generation for testing

### Testing Requirements

**Unit Testing:**

- Form validation functions
- User ID generation logic
- Component rendering tests
- API integration mocking

**Integration Testing:**

- Complete Create, Read, Update workflows
- Form submission flows
- Error handling scenarios
- Responsive design testing

**Accessibility Testing:**

- Keyboard navigation
- Screen reader compatibility
- Color contrast validation
- Focus management

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-11-14 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug logs were required during implementation. All tasks completed successfully without errors.

### Completion Notes List

1. **Authentication System**: Successfully implemented login page with Supabase Auth integration, JWT token management, and proper error handling.

2. **Route Protection**: Implemented Next.js 16 proxy configuration for authentication and role-based access control.

3. **RLS Policies**: Configured comprehensive Row Level Security policies with admin role checking. Admin (test@example.com) can SELECT/INSERT/UPDATE all rows, regular users can only SELECT their own rows by employee ID or human readable user ID.

4. **Admin Role Assignment**: Successfully updated test@example.com user metadata with admin role in raw_user_meta_data.

5. **Zustand Stores**: Created proper state management architecture using shared types from @pgn/shared package. Auth store, Employee store, and UI store implemented.

6. **Dashboard Structure**: Complete dashboard with navigation, user management interface, and responsive design.

7. **Employee List Page**: Full employee listing with search, filtering, pagination, and admin-only actions.

8. **Create Employee Form**: Complete employee creation with validation for required fields, email format, and Indian phone numbers.

9. **Edit Employee Form**: Employee editing with pre-filled data, validation, and status management.

10. **Employment Status Changes**: Implemented status change dialog with confirmation and reason tracking.

11. **Global Error Handling**: React Error Boundary, toast notifications, loading states, and retry functionality.

12. **Service Layer Integration**: API routes created for all CRUD operations with proper error handling and service layer integration points.

### File List

**New Files Created:**
- `apps/web/app/(dashboard)/login/login-client.tsx` - Login form component
- `apps/web/app/(dashboard)/login/page.tsx` - Login page server component
- `apps/web/app/(dashboard)/layout.tsx` - Dashboard layout with auth
- `apps/web/app/(dashboard)/page.tsx` - Main dashboard page
- `apps/web/app/(dashboard)/employees/page.tsx` - Employee list page
- `apps/web/app/(dashboard)/employees/employees-list-client.tsx` - Employee list component
- `apps/web/app/(dashboard)/employees/create/page.tsx` - Create employee page
- `apps/web/app/(dashboard)/employees/create/create-employee-client.tsx` - Create form component
- `apps/web/app/(dashboard)/employees/[id]/edit/page.tsx` - Edit employee page
- `apps/web/app/(dashboard)/employees/[id]/edit/edit-employee-client.tsx` - Edit form component
- `apps/web/app/(dashboard)/components/ui/error-boundary.tsx` - React Error Boundary component
- `apps/web/app/(dashboard)/components/ui/notifications.tsx` - Toast notification system
- `apps/web/app/(dashboard)/components/ui/loading-spinner.tsx` - Loading spinner component
- `apps/web/app/lib/stores/authStore.ts` - Authentication state management
- `apps/web/app/lib/stores/employeeStore.ts` - Employee data management
- `apps/web/app/lib/stores/uiStore.ts` - UI state and notifications
- `apps/web/proxy.ts` - Next.js 16 proxy for route protection
- `apps/web/app/api/employees/route.ts` - Employees API endpoints
- `apps/web/app/api/employees/[id]/route.ts` - Individual employee API
- `apps/web/app/api/employees/[id]/status/route.ts` - Employment status update API

**Database Changes:**
- Supabase RLS policies updated for role-based access control
- test@example.com user metadata updated with admin role

**Dependencies Added:**
- `zustand` - State management
- `framer-motion` - Animations and transitions
- `react-hook-form` - Form management
- `@hookform/resolvers` - Form validation resolvers
- `zod` - Schema validation
- `@supabase/auth-ui-react` - Supabase Auth UI components
- `@supabase/auth-ui-shared` - Shared Auth UI styles

## QA Results

<!-- To be filled by QA Agent -->
